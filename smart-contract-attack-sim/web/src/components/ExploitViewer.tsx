'use client';

import { useState } from 'react';

interface ExploitViewerProps {
  code: string;
  contractName: string;
}

export default function ExploitViewer({ code, contractName }: ExploitViewerProps) {
  const [copied, setCopied] = useState(false);

  const copyToClipboard = async () => {
    try {
      await navigator.clipboard.writeText(code);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  const downloadFile = () => {
    const blob = new Blob([code], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `exploit_${contractName.toLowerCase()}.t.sol`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const lineCount = code.split('\n').length;

  return (
    <div className="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden">
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 bg-gray-800 border-b border-gray-700">
        <div className="flex items-center gap-2">
          <span className="text-green-400">âœ…</span>
          <h3 className="font-medium text-gray-200">Generated Exploit Test</h3>
          <span className="text-xs text-gray-500">Foundry/Forge compatible</span>
        </div>
        <div className="flex items-center gap-2">
          <button
            onClick={copyToClipboard}
            className="flex items-center gap-1 px-3 py-1.5 text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors"
          >
            {copied ? (
              <>
                <span>âœ“</span>
                <span>Copied!</span>
              </>
            ) : (
              <>
                <span>ðŸ“‹</span>
                <span>Copy</span>
              </>
            )}
          </button>
          <button
            onClick={downloadFile}
            className="flex items-center gap-1 px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded transition-colors"
          >
            <span>â¬‡</span>
            <span>Download .sol</span>
          </button>
        </div>
      </div>

      {/* Code */}
      <div className="flex overflow-auto max-h-[500px]">
        {/* Line numbers */}
        <div className="flex-shrink-0 bg-gray-800 text-gray-500 text-right py-4 px-3 select-none font-mono text-sm border-r border-gray-700">
          {Array.from({ length: lineCount }, (_, i) => (
            <div key={i + 1} className="leading-5">
              {i + 1}
            </div>
          ))}
        </div>
        {/* Code content */}
        <pre className="flex-1 p-4 text-sm font-mono text-gray-300 overflow-x-auto">
          <code>{highlightSolidity(code)}</code>
        </pre>
      </div>

      {/* Footer */}
      <div className="px-4 py-3 bg-gray-800 border-t border-gray-700">
        <p className="text-sm text-gray-400">
          <span className="text-yellow-500">âš </span> Run this test with:{' '}
          <code className="bg-gray-700 px-2 py-0.5 rounded text-green-400">
            forge test --match-test testReentrancyExploit -vvv
          </code>
        </p>
      </div>
    </div>
  );
}

// Simple syntax highlighting
function highlightSolidity(code: string): React.ReactNode {
  const keywords = ['pragma', 'solidity', 'contract', 'function', 'public', 'external', 'internal', 'private', 'view', 'pure', 'payable', 'returns', 'return', 'if', 'else', 'for', 'while', 'require', 'import', 'is', 'new', 'address', 'uint256', 'uint', 'bool', 'string', 'bytes', 'mapping', 'memory', 'storage', 'calldata', 'constructor', 'modifier', 'event', 'emit', 'indexed', 'receive', 'fallback'];

  const lines = code.split('\n');

  return lines.map((line, i) => {
    let highlighted = line;

    // Comments
    if (line.trim().startsWith('//')) {
      return <div key={i} className="text-gray-500 leading-5">{line}</div>;
    }

    // Strings
    highlighted = highlighted.replace(/"([^"]*)"/g, '<span class="text-green-400">"$1"</span>');

    // Keywords
    keywords.forEach(kw => {
      const regex = new RegExp(`\\b(${kw})\\b`, 'g');
      highlighted = highlighted.replace(regex, '<span class="text-purple-400">$1</span>');
    });

    // Numbers
    highlighted = highlighted.replace(/\b(\d+)\b/g, '<span class="text-yellow-400">$1</span>');

    return <div key={i} className="leading-5" dangerouslySetInnerHTML={{ __html: highlighted }} />;
  });
}
